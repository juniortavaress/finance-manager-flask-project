{% macro render_investments(title, companies) %}
    {% set symbol = "$" if broker_name|lower == "nomad" else "R$" %}
    {% if companies %}
        <h3>{{ title }}</h3>
        <div class="investments-grid">
            {% for company_name, records in companies.items() %}
                {% set latest = records[-1] %}
                <article class="investment-card-companies">
                    <div class="investment-title-wrapper">
                        <div class="investment-info">
                            <h2 class="investment-title-companies">{{ company_name }}</h2>
                            <span class="investment-date">
                                Última atualização: {{ latest.date.strftime('%d/%m/%Y') }}
                            </span>
                        </div>
                            <a href="{{ url_for('finance.' ~ broker_name|lower, name=company_name) }}" class="details-button">
                            <span class="material-symbols-outlined">open_in_full</span>
                        </a>
                    </div>

                    <div class="investment-content-grid">
                        {% set items = [
                            {"label": "Number of Shares", "icon": "grid_view", "value": latest.quantity}, 
                            {"label": "Dividends (" ~ symbol ~ ")", "icon": "payments", "value": latest.dividends},
                            {"label": "Total Invested (" ~ symbol ~ ")", "icon": "price_check", "value": latest.price_total_invested},
                            {"label": "Current Value (" ~ symbol ~ ")", "icon": "trending_up", "value": latest.price_total_current},
                            {"label": "Profit (" ~ symbol ~ ")", "icon": "show_chart", "value": latest.profit},
                            {"label": "Profitability (%)", "icon": "insights", "value": latest.profitability }
                        ] %}
                        {% for item in items %}
                            <div class="companies-grid-item">
                                <span class="material-symbols-outlined investment-icon-cards">{{ item.icon }}</span>
                                <div class="investment-info">
                                    <span class="investment-label">{{ item.label }}</span>
                                    <span class="investment-value">
                                        {{ "%.2f"|format(item.value or 0) }}
                                    </span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </article>
            {% endfor %}
        </div>
    {% endif %}
{% endmacro %}

{% set companies = datas_ativos.get(broker_name, {}) %}

{% set funds = {} %}
{% set stocks = {} %}
{% set cripto = {} %}
{% set renda_fixa = {} %}

{% for company_name, records in companies.items() %}
    {% set latest = records[-1] %}
    {% if latest.investment_type in ['cripto'] %}
        {% set _ = cripto.update({company_name: records}) %}
    {% elif latest.investment_type in ['fixed_income', 'bond'] %}
        {% set _ = renda_fixa.update({company_name: records}) %}
    {% elif latest.investment_type in ['real_state', 'real estate fund', 'fund'] %}
        {% set _ = funds.update({company_name: records}) %}
    {% elif latest.investment_type in ['stock', 'foreign stock (USD)'] %}
        {% set _ = stocks.update({company_name: records}) %}
    {% endif %}
{% endfor %}

<div class="investments">
    <div class="investment-graph">
        <div class="header-graph">
            <div class="title-graph">
                {{ selected_company_name if selected_company_name else 'Ativo Selecionado' }}
            </div>
        </div>

        {% set graph_symbol = "$" if broker_name|lower == "nomad" else "R$" %}
        <div class="chart-metrics">
            <button class="metric-btn active" data-metric="current_invested" data-color="#3498db">Preço Atual ({{ graph_symbol }})</button>
            <button class="metric-btn" data-metric="invested" data-color="#2ecc71">Preço Médio ({{ graph_symbol }})</button>
            <button class="metric-btn" data-metric="price_total_invested" data-color="#e67e22">Preço Total Investido ({{ graph_symbol }})</button>
            <button class="metric-btn" data-metric="price_total_current" data-color="#2980b9">Preço Total Atual ({{ graph_symbol }})</button>
            <button class="metric-btn" data-metric="dividends" data-color="#9b59b6">Dividendos ({{ graph_symbol }})</button>
            <button class="metric-btn" data-metric="profit" data-color="#f1c40f">Lucro ({{ graph_symbol }})</button>
            <button class="metric-btn" data-metric="quantity" data-color="#1abc9c">Número de Ativos</button>
        </div>

        <div class="chart-container">
            <canvas id="investmentChartNu"></canvas>
        </div>
    </div>

    {{ render_investments('Cripto', cripto) }}
    {{ render_investments('Renda Fixa', renda_fixa) }}
    {{ render_investments('FIIs', funds) }}
    {{ render_investments('Ações', stocks) }}
    
</div>


